<modification>
	<id>Print Email Invoices</id>
	<version>20140427</version>
	<vqmver>2.4.1</vqmver>
	<author>Digital Web Depot</author>
	
	<file name="admin/controller/sale/order.php">
		<operation>
			<search position="before"><![CDATA[
				public function insert() {
			]]></search>
			<add><![CDATA[
				public function sendEmails() {
					$this->load->language('sale/order');
					$this->load->model('sale/order');
					$this->load->model('setting/setting');
					$orders = array();
					if (isset($this->request->post['selected'])) {
						$orders = $this->request->post['selected'];
					} elseif (isset($this->request->get['order_id'])) {
						$orders[] = $this->request->get['order_id'];
					}
					if (isset($this->request->get['pdf'])) {
						$pdf = true;
					} else {
						$pdf = false;
					}
					foreach ($orders as $order_id) {
						$template = new Template();
						$template->data['title'] = $this->language->get('heading_title');
						if (isset($this->request->server['HTTPS']) && (($this->request->server['HTTPS'] == 'on') || ($this->request->server['HTTPS'] == '1'))) {
							$template->data['base'] = HTTPS_SERVER;
						} else {
							$template->data['base'] = HTTP_SERVER;
						}
						$template->data['direction'] = $this->language->get('direction');
						$template->data['language'] = $this->language->get('code');
						$template->data['text_invoice'] = $this->language->get('text_invoice');
						$template->data['text_order_id'] = $this->language->get('text_order_id');
						$template->data['text_invoice_no'] = $this->language->get('text_invoice_no');
						$template->data['text_invoice_date'] = $this->language->get('text_invoice_date');
						$template->data['text_date_added'] = $this->language->get('text_date_added');
						$template->data['text_telephone'] = $this->language->get('text_telephone');
						$template->data['text_fax'] = $this->language->get('text_fax');
						$template->data['text_to'] = $this->language->get('text_to');
						$template->data['text_company_id'] = $this->language->get('text_company_id');
						$template->data['text_tax_id'] = $this->language->get('text_tax_id');		
						$template->data['text_ship_to'] = $this->language->get('text_ship_to');
						$template->data['text_payment_method'] = $this->language->get('text_payment_method');
						$template->data['text_shipping_method'] = $this->language->get('text_shipping_method');
						$template->data['column_product'] = $this->language->get('column_product');
						$template->data['column_model'] = $this->language->get('column_model');
						$template->data['column_quantity'] = $this->language->get('column_quantity');
						$template->data['column_price'] = $this->language->get('column_price');
						$template->data['column_total'] = $this->language->get('column_total');
						$template->data['column_comment'] = $this->language->get('column_comment');
						$order_info = $this->model_sale_order->getOrder($order_id);
						if ($order_info) {
							$store_info = $this->model_setting_setting->getSetting('config', $order_info['store_id']);
							$template->data['store_name'] = $order_info['store_name'];
							$template->data['store_url'] = $order_info['store_url'];
							if ($store_info) {
								$template->data['logo'] = $template->data['store_url'] . 'image/' . $store_info['config_logo'];
							} else {
								$template->data['logo'] = $template->data['store_url'] . 'image/' . $this->config->get('config_logo');
							}
							if ($store_info) {
								$store_address = $store_info['config_address'];
								$store_email = $store_info['config_email'];
								$store_telephone = $store_info['config_telephone'];
								$store_fax = $store_info['config_fax'];
							} else {
								$store_address = $this->config->get('config_address');
								$store_email = $this->config->get('config_email');
								$store_telephone = $this->config->get('config_telephone');
								$store_fax = $this->config->get('config_fax');
							}
							if ($order_info['invoice_no']) {
								$invoice_no = $order_info['invoice_prefix'] . $order_info['invoice_no'];
							} else {
								$invoice_no = '';
							}
							if ($order_info['shipping_address_format']) {
								$format = $order_info['shipping_address_format'];
							} else {
								$format = '{firstname} {lastname}' . "\n" . '{company}' . "\n" . '{address_1}' . "\n" . '{address_2}' . "\n" . '{city} {postcode}' . "\n" . '{zone}' . "\n" . '{country}';
							}
							$find = array(
								'{firstname}',
								'{lastname}',
								'{company}',
								'{address_1}',
								'{address_2}',
								'{city}',
								'{postcode}',
								'{zone}',
								'{zone_code}',
								'{country}'
							);
							$replace = array(
								'firstname' => $order_info['shipping_firstname'],
								'lastname'  => $order_info['shipping_lastname'],
								'company'   => $order_info['shipping_company'],
								'address_1' => $order_info['shipping_address_1'],
								'address_2' => $order_info['shipping_address_2'],
								'city'      => $order_info['shipping_city'],
								'postcode'  => $order_info['shipping_postcode'],
								'zone'      => $order_info['shipping_zone'],
								'zone_code' => $order_info['shipping_zone_code'],
								'country'   => $order_info['shipping_country']
							);
							$shipping_address = str_replace(array("\r\n", "\r", "\n"), '<br />', preg_replace(array("/\s\s+/", "/\r\r+/", "/\n\n+/"), '<br />', trim(str_replace($find, $replace, $format))));
							if ($order_info['payment_address_format']) {
								$format = $order_info['payment_address_format'];
							} else {
								$format = '{firstname} {lastname}' . "\n" . '{company}' . "\n" . '{address_1}' . "\n" . '{address_2}' . "\n" . '{city} {postcode}' . "\n" . '{zone}' . "\n" . '{country}';
							}
							$find = array(
								'{firstname}',
								'{lastname}',
								'{company}',
								'{address_1}',
								'{address_2}',
								'{city}',
								'{postcode}',
								'{zone}',
								'{zone_code}',
								'{country}'
							);
							$replace = array(
								'firstname' => $order_info['payment_firstname'],
								'lastname'  => $order_info['payment_lastname'],
								'company'   => $order_info['payment_company'],
								'address_1' => $order_info['payment_address_1'],
								'address_2' => $order_info['payment_address_2'],
								'city'      => $order_info['payment_city'],
								'postcode'  => $order_info['payment_postcode'],
								'zone'      => $order_info['payment_zone'],
								'zone_code' => $order_info['payment_zone_code'],
								'country'   => $order_info['payment_country']
							);
							$payment_address = str_replace(array("\r\n", "\r", "\n"), '<br />', preg_replace(array("/\s\s+/", "/\r\r+/", "/\n\n+/"), '<br />', trim(str_replace($find, $replace, $format))));
							$product_data = array();
							$products = $this->model_sale_order->getOrderProducts($order_id);
							foreach ($products as $product) {
								$option_data = array();
								$options = $this->model_sale_order->getOrderOptions($order_id, $product['order_product_id']);
								foreach ($options as $option) {
									if ($option['type'] != 'file') {
										$value = $option['value'];
									} else {
										$value = utf8_substr($option['value'], 0, utf8_strrpos($option['value'], '.'));
									}
									$option_data[] = array(
										'name'  => $option['name'],
										'value' => $value
									);								
								}
								$product_data[] = array(
									'name'     => $product['name'],
									'model'    => $product['model'],
									'option'   => $option_data,
									'quantity' => $product['quantity'],
									'price'    => $this->currency->format($product['price'] + ($this->config->get('config_tax') ? $product['tax'] : 0), $order_info['currency_code'], $order_info['currency_value']),
									'total'    => $this->currency->format($product['total'] + ($this->config->get('config_tax') ? ($product['tax'] * $product['quantity']) : 0), $order_info['currency_code'], $order_info['currency_value'])
								);
							}
							$voucher_data = array();
							if (version_compare(VERSION, '1.5.1.3.1', '>')) {
								$vouchers = $this->model_sale_order->getOrderVouchers($order_id);
								foreach ($vouchers as $voucher) {
									$voucher_data[] = array(
										'description' => $voucher['description'],
										'amount'      => $this->currency->format($voucher['amount'], $order_info['currency_code'], $order_info['currency_value'])			
									);
								}
							}
							$total_data = $this->model_sale_order->getOrderTotals($order_id);
							$template->data['orders'] = array();
							$template->data['orders'][] = array(
								'order_id'	         => $order_id,
								'invoice_no'         => $invoice_no,
								'date_added'         => date($this->language->get('date_format_short'), strtotime($order_info['date_added'])),
								'store_name'         => $order_info['store_name'],
								'store_url'          => rtrim($order_info['store_url'], '/'),
								'store_address'      => nl2br($store_address),
								'store_email'        => $store_email,
								'store_telephone'    => $store_telephone,
								'store_fax'          => $store_fax,
								'email'              => $order_info['email'],
								'telephone'          => $order_info['telephone'],
								'shipping_address'   => $shipping_address,
								'shipping_method'    => $order_info['shipping_method'],
								'payment_address'    => $payment_address,
								'payment_company_id' => (isset($order_info['payment_company_id']) ? $order_info['payment_company_id'] : ''),
								'payment_tax_id'     => (isset($order_info['payment_tax_id']) ? $order_info['payment_tax_id'] : ''),
								'payment_method'     => $order_info['payment_method'],
								'product'            => $product_data,
								'voucher'            => $voucher_data,
								'total'              => $total_data,
								'comment'            => nl2br($order_info['comment'])
							);
							$template->data['this_email'] = 1;
							if (isset($order_info['layaway_deposit']) && $order_info['layaway_deposit'] != 0.0000 && $order_info['layaway_deposit'] != "") {
								$template->data['layaways'] = array();
								$layaways = $this->db->query("SELECT * FROM " . DB_PREFIX . "order_layaway WHERE order_id = '" . (int)$order_id . "' ORDER BY date_added DESC");
								$template->data['deposit_layaway'] = $this->currency->format($order_info['layaway_deposit']);
								$total_paid = 0;
								foreach ($layaways->rows as $layaway) {
									$total_paid = $layaway['deposit'];
									if (!empty($layaway['payments'])) {
										foreach (unserialize($layaway['payments']) as $payment) {
											$total_paid += $payment['payment_amount'];
											$template->data['layaways'][] = array(
												'amount'		=> $this->currency->format($payment['payment_amount'], $this->config->get('config_currency')),
												'description'	=> $payment['payment_description'],
												'date_added'	=> date($this->language->get('date_format_short'), ($payment['payment_date']))
											);
										}
									}
								}
								$template->data['layaway_balance'] = $this->currency->format($order_info['total'] - $total_paid);
							}
							$html = $template->fetch('sale/order_invoice.tpl');
							if ($pdf) {
								require_once(DIR_SYSTEM . 'library/dompdf/dompdf_config.inc.php');
								$dompdf = new DOMPDF();
								$dompdf->load_html($html);
								$dompdf->render();
								$pdfoutput = $dompdf->output();
								$filepath = DIR_CACHE;
								$filename = "invoice_" . $order_id . ".pdf";
								$fp = fopen($filepath . $filename, "w");
								fwrite($fp, $pdfoutput);
								fclose($fp);
							}
							if (isset($this->request->get['type']) && $this->request->get['type'] == 'client' || isset($this->request->post['type']) && $this->request->post['type'] == 'client') {
								$email_to = $order_info['email'];
							} else {
								$email_to = $store_email;
							}
							$subject = "Order # " . $order_id . " from " . $order_info['store_name'];
							$mail = new Mail();
							$mail->protocol = $this->config->get('config_mail_protocol');
							$mail->parameter = $this->config->get('config_mail_parameter');
							$mail->hostname = $this->config->get('config_smtp_host');
							$mail->username = $this->config->get('config_smtp_username');
							$mail->password = $this->config->get('config_smtp_password');
							$mail->port = $this->config->get('config_smtp_port');
							$mail->timeout = $this->config->get('config_smtp_timeout');
							$mail->setTo($email_to);
							$mail->setFrom($store_email);
							$mail->setSender($order_info['store_name']);
							$mail->setSubject(html_entity_decode($subject, ENT_QUOTES, 'UTF-8'));
							$mail->setHtml($html);
							if ($pdf) {
								$mail->addAttachment($filepath . $filename, $filename);
							}
							$mail->send();
						}
						unlink($filepath . $filename);
					}
					if (!empty($orders)) {
						if (isset($this->request->post['type']) && $this->request->post['type'] == 'client' || isset($this->request->get['type']) && $this->request->get['type'] == 'client') {
							$this->session->data['success'] = "The selected order emails have been sent to the customers!";
						} else {
							$this->session->data['success'] = "The selected order emails have been sent to the store owner!";
						}
					} else {
						$this->session->data['success'] = "No orders were selected!";
					}
					if (isset($this->request->get['redirect'])) {
						$json = $this->session->data['success'];
						unset($this->session->data['success']);
						echo json_encode($json);
					} else {
						$this->redirect($this->url->link('sale/order', 'token=' . $this->session->data['token'], 'SSL'));
					}
				}
			]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
				$this->data['invoice'] = $this->url->link('sale/order/invoice', 'token=' . $this->session->data['token'], 'SSL');
			]]></search>
			<add><![CDATA[
				$this->data['email_client'] = $this->url->link('sale/order/sendEmails', 'token=' . $this->session->data['token'] . '&type=client', 'SSL');
				$this->data['email_owner'] = $this->url->link('sale/order/sendEmails', 'token=' . $this->session->data['token'] . '&type=owner', 'SSL');
				$this->data['email_client_pdf'] = $this->url->link('sale/order/sendEmails', 'token=' . $this->session->data['token'] . '&type=client&pdf=1', 'SSL');
				$this->data['email_owner_pdf'] = $this->url->link('sale/order/sendEmails', 'token=' . $this->session->data['token'] . '&type=owner&pdf=1', 'SSL');
				$this->data['invoice_pdf'] = $this->url->link('sale/order/invoice', 'token=' . $this->session->data['token'] . '&pdf=1', 'SSL');
			]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
				$this->data['invoice'] = $this->url->link('sale/order/invoice', 'token=' . $this->session->data['token'] . '&order_id=' . (int)$this->request->get['order_id'], 'SSL');
			]]></search>
			<add><![CDATA[
				$this->data['invoice_pdf'] = $this->url->link('sale/order/invoice', 'token=' . $this->session->data['token'] . '&order_id=' . (int)$this->request->get['order_id'] . '&pdf=1', 'SSL');
			]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
				$this->data['button_invoice'] = $this->language->get('button_invoice');
			]]></search>
			<add><![CDATA[
				$this->data['button_email_client'] = $this->language->get('button_email_client');
				$this->data['button_email_owner'] = $this->language->get('button_email_owner');
				$this->data['button_email_client_pdf'] = $this->language->get('button_email_client_pdf');
				$this->data['button_email_owner_pdf'] = $this->language->get('button_email_owner_pdf');
				$this->data['button_invoice_pdf'] = $this->language->get('button_invoice_pdf');
				$this->data['error_nothing_checked'] = $this->language->get('error_nothing_checked');
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
				$total_data = $this->model_sale_order->getOrderTotals($order_id);
			]]></search>
			<add><![CDATA[
				if (isset($order_info['layaway_deposit']) && $order_info['layaway_deposit'] != 0.0000 && $order_info['layaway_deposit'] != "") {
					$this->data['layaways'] = array();
					$layaways = $this->db->query("SELECT * FROM " . DB_PREFIX . "order_layaway WHERE order_id = '" . (int)$order_id . "' ORDER BY date_added DESC");
					$this->data['deposit_layaway'] = $this->currency->format($order_info['layaway_deposit']);
					$total_paid = 0;
					foreach ($layaways->rows as $layaway) {
						$total_paid = $layaway['deposit'];
						if (!empty($layaway['payments'])) {
							foreach (unserialize($layaway['payments']) as $payment) {
								$total_paid += $payment['payment_amount'];
								$this->data['layaways'][] = array(
									'amount'		=> $this->currency->format($payment['payment_amount'], $this->config->get('config_currency')),
									'description'	=> $payment['payment_description'],
									'date_added'	=> date($this->language->get('date_format_short'), ($payment['payment_date']))
								);
							}
						}
					}
					$this->data['layaway_balance'] = $this->currency->format($order_info['total'] - $total_paid);
				}
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
				$store_info = $this->model_setting_setting->getSetting('config', $order_info['store_id']);
			]]></search>
			<add><![CDATA[
				$store_name = $order_info['store_name'];
				$store_url = $order_info['store_url'];
				if (strpos($store_url, "admin") !== false) {
					$store_url = str_replace("admin/", "", $store_url);
					$store_url = str_replace("admin", "", $store_url);
				}
				if ($store_info) {
					$logo = $store_url . 'image/' . $store_info['config_logo'];
				} else {
					$logo = $store_url . 'image/' . $this->config->get('config_logo');
				}
			]]></add>
		</operation>
		<operation>
			<search position="replace" offset="1"><![CDATA[
				=> $order_info['store_name'],
			]]></search>
			<add><![CDATA[
				=> $store_name,
				'store_url'			 => $store_url,
				'logo'				 => $logo,
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
				$this->template = 'sale/order_invoice.tpl';
			]]></search>
			<add><![CDATA[
				$this->template = 'sale/order_invoice.tpl';
				if (isset($this->request->get['pdf'])) {
					$html = $this->render();
					require_once(DIR_SYSTEM . 'library/dompdf/dompdf_config.inc.php');
					$dompdf = new DOMPDF();
					$dompdf->load_html($html);
					$dompdf->render();
					$pdfoutput = $dompdf->output();
					$filepath = DIR_CACHE;
					$filename = "invoice_" . $order_id . ".pdf";
					$fp = fopen($filepath . $filename, "w");
					fwrite($fp, $pdfoutput);
					fclose($fp);
					header('Content-Transfer-Encoding: binary');
					header('Content-Type: application/pdf');
					header('Content-Disposition: attachment; filename="' . $filename . '"');
					header('Content-Length: '.filesize($filepath . $filename));
					readfile($filepath . $filename);
					unlink($filepath . $filename);
				}
			]]></add>
		</operation>
	</file>
	
	<file name="admin/language/english/sale/order.php">
		<operation>
			<search position="before"><![CDATA[
				// Error
			]]></search>
			<add><![CDATA[
				// Button
				$_['button_email_client']		= 'Email Customer';
				$_['button_email_owner']		= 'Email Owner';
				$_['button_email_client_pdf']	= 'Email Customer (PDF)';
				$_['button_email_owner_pdf']	= 'Email Owner (PDF)';
				$_['button_invoice_pdf']		= 'Print Invoice (PDF)';
				$_['error_nothing_checked']		= 'You did not select any orders to email or print!';
			]]></add>
		</operation>
	</file>
	
	<file name="admin/model/sale/order.php">
		<operation>
			<search position="before"><![CDATA[
				$language_info = $this->model_localisation_language->getLanguage($order_query->row['language_id']);
			]]></search>
			<add><![CDATA[
				if (isset($order_query->row['layaway_deposit'])) {
					$layaway_deposit = $order_query->row['layaway_deposit'];
				} else {
					$layaway_deposit = "";
				}
			]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
				'date_added'              => $order_query->row['date_added'],
			]]></search>
			<add><![CDATA[
				'layaway_deposit'		  => $layaway_deposit,
			]]></add>
		</operation>
	</file>
	
	<file name="admin/view/template/sale/order_info.tpl">
		<operation error="skip">
			<search position="replace"><![CDATA[
				<a href="<?php echo $invoice; ?>" target="_blank" class="button">
			]]></search>
			<add><![CDATA[
				<a id="email_client_pdf" title="<?php echo $order_id; ?>" class="button"><?php echo $button_email_client_pdf; ?></a>
				<a id="email_client" title="<?php echo $order_id; ?>" class="button"><?php echo $button_email_client; ?></a>
				<a id="email_owner_pdf" title="<?php echo $order_id; ?>" class="button"><?php echo $button_email_owner_pdf; ?></a>
				<a id="email_owner" title="<?php echo $order_id; ?>" class="button"><?php echo $button_email_owner; ?></a>
				<a href="<?php echo $invoice_pdf; ?>" target="_blank" class="button"><?php echo $button_invoice_pdf; ?></a>
				<a href="<?php echo $invoice; ?>" target="_blank" class="button">
			]]></add>
		</operation>
		<operation error="skip">
			<search position="replace"><![CDATA[
				<a onclick="window.open('<?php echo $invoice; ?>');" class="button"><?php echo $button_invoice; ?></a>
			]]></search>
			<add><![CDATA[
				<a id="email_client_pdf" title="<?php echo $order_id; ?>" class="button"><?php echo $button_email_client_pdf; ?></a>
				<a id="email_client" title="<?php echo $order_id; ?>" class="button"><?php echo $button_email_client; ?></a>
				<a id="email_owner_pdf" title="<?php echo $order_id; ?>" class="button"><?php echo $button_email_owner_pdf; ?></a>
				<a id="email_owner" title="<?php echo $order_id; ?>" class="button"><?php echo $button_email_owner; ?></a>
				<a onclick="window.open('<?php echo $invoice_pdf; ?>');" class="button"><?php echo $button_invoice_pdf; ?></a>
				<a onclick="window.open('<?php echo $invoice; ?>');" class="button"><?php echo $button_invoice; ?></a>
			]]></add>
		</operation>
		<operation error="skip">
			<search position="before"><![CDATA[
				$('#invoice-generate').live('click', function() {
			]]></search>
			<add><![CDATA[
				$('#email_client_pdf').live('click', function() {
					var order_id = $(this).attr('title');
					$.ajax({
						url: 'index.php?route=sale/order/sendEmails&token=<?php echo $token; ?>&redirect=no&type=client&pdf=1&order_id=' + order_id,
						type: 'GET',
						dataType: 'json',
						success: function(json) {
							alert(json);
						}
					});
				});
				$('#email_client').live('click', function() {
					var order_id = $(this).attr('title');
					$.ajax({
						url: 'index.php?route=sale/order/sendEmails&token=<?php echo $token; ?>&redirect=no&type=client&order_id=' + order_id,
						type: 'GET',
						dataType: 'json',
						success: function(json) {
							alert(json);
						}
					});
				});
				$('#email_owner_pdf').live('click', function() {
					var order_id = $(this).attr('title');
					$.ajax({
						url: 'index.php?route=sale/order/sendEmails&token=<?php echo $token; ?>&redirect=no&type=owner&pdf=1&order_id=' + order_id,
						type: 'GET',
						dataType: 'json',
						success: function(json) {
							alert(json);
						}
					});
				});
				$('#email_owner').live('click', function() {
					var order_id = $(this).attr('title');
					$.ajax({
						url: 'index.php?route=sale/order/sendEmails&token=<?php echo $token; ?>&redirect=no&type=owner&order_id=' + order_id,
						type: 'GET',
						dataType: 'json',
						success: function(json) {
							alert(json);
						}
					});
				});
			]]></add>
		</operation>
		<operation error="skip">
			<search position="before"><![CDATA[
				$('#invoice-create').live('click', function() {
			]]></search>
			<add><![CDATA[
				$('#email_client_pdf').live('click', function() {
					var order_id = $(this).attr('title');
					$.ajax({
						url: 'index.php?route=sale/order/sendEmails&token=<?php echo $token; ?>&redirect=no&type=client&pdf=1&order_id=' + order_id,
						type: 'GET',
						dataType: 'json',
						success: function(json) {
							alert(json);
						}
					});
				});
				$('#email_client').live('click', function() {
					var order_id = $(this).attr('title');
					$.ajax({
						url: 'index.php?route=sale/order/sendEmails&token=<?php echo $token; ?>&redirect=no&type=client&order_id=' + order_id,
						type: 'GET',
						dataType: 'json',
						success: function(json) {
							alert(json);
						}
					});
				});
				$('#email_owner_pdf').live('click', function() {
					var order_id = $(this).attr('title');
					$.ajax({
						url: 'index.php?route=sale/order/sendEmails&token=<?php echo $token; ?>&redirect=no&type=owner&pdf=1&order_id=' + order_id,
						type: 'GET',
						dataType: 'json',
						success: function(json) {
							alert(json);
						}
					});
				});
				$('#email_owner').live('click', function() {
					var order_id = $(this).attr('title');
					$.ajax({
						url: 'index.php?route=sale/order/sendEmails&token=<?php echo $token; ?>&redirect=no&type=owner&order_id=' + order_id,
						type: 'GET',
						dataType: 'json',
						success: function(json) {
							alert(json);
						}
					});
				});
			]]></add>
		</operation>
	</file>
	
	<file name="admin/view/template/sale/order_invoice.tpl">
		<!--<operation>
			<search position="after"><![CDATA[
				<link rel="stylesheet" type="text/css" href="view/stylesheet/invoice.css" />
			]]></search>
			<add><![CDATA[
				<script type="text/javascript" src="view/javascript/jquery/jquery-1.7.1.min.js"></script>
			]]></add>
		</operation>//-->
		<operation>
			<search position="before"><![CDATA[
				<h1><?php echo $text_invoice; ?></h1>
			]]></search>
			<add><![CDATA[
				<?php if (isset($order['store_url'])) { ?>
					<a href="<?php echo $order['store_url']; ?>" title="<?php echo $order['store_name']; ?>"><img src="<?php echo $order['logo']; ?>" alt="<?php echo $order['store_name']; ?>" style="border: none;" /></a>
				<?php } elseif (isset($store_url)) { ?>
					<a href="<?php echo $store_url; ?>" title="<?php echo $store_name; ?>"><img src="<?php echo $logo; ?>" alt="<?php echo $store_name; ?>" style="border: none;" /></a>
				<?php } ?>
			]]></add>
		</operation>
		<operation>
			<search position="before" index="4"><![CDATA[
				</table>
			]]></search>
			<add><![CDATA[
				<?php if (isset($deposit_layaway)) { ?>
					<tr>
					  <td align="right" colspan="4"><b>Layaway Deposit:</b></td>
					  <td align="right"><?php echo $deposit_layaway; ?></td>
					</tr>
					<?php foreach ($layaways as $layaway) { ?>
						<tr>
							<td align="right" colspan="4"><b><?php echo $layaway['date_added']; ?> - <?php echo $layaway['description']; ?></b></td>
							<td align="right"><?php echo $layaway['amount']; ?></td>
						</tr>
					<?php } ?>
					<tr>
					  <td align="right" colspan="4"><b>Layaway Balance:</b></td>
					  <td align="right"><?php echo $layaway_balance; ?></td>
					</tr>
				<?php } ?>
			]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
				</body>
			]]></search>
			<add><![CDATA[
				<?php if (!isset($this_email)) { ?>
					<script type="text/javascript">
						$(document).ready(function() {
							window.print("about:blank");
							document.write(htmlPage);
							window.close();
						});
					</script>
				<?php } ?>
			]]></add>
		</operation>
	</file>
	
	<file name="admin/view/template/sale/order_list.tpl">
		<operation>
			<search position="replace" offset="5"><![CDATA[
				<?php if ($error_warning) { ?>
			]]></search>
			<add><![CDATA[
				<?php if ($error_warning) { ?>
					<div class="warning"><?php echo $error_warning; ?></div>
				<?php } else { ?>
					<div class="warning" style="display: none;"></div>
				<?php } ?>
				<?php if ($success) { ?>
					<div class="success"><?php echo $success; ?></div>
				<?php } else { ?>
					<div class="success" style="display: none;"></div>
				<?php } ?>
			]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
				<a onclick="$('#form').attr('action', '<?php echo $invoice; ?>'); $('#form').attr('target', '_blank'); $('#form').submit();" class="button"><?php echo $button_invoice; ?></a>
			]]></search>
			<add><![CDATA[
				<a onclick="if (boxesChecked()) { $('#form').attr('action', '<?php echo $email_client_pdf; ?>'); $('#form').removeAttr('target'); $('#form').submit(); }" class="button"><?php echo $button_email_client_pdf; ?></a>
				<a onclick="if (boxesChecked()) { $('#form').attr('action', '<?php echo $email_client; ?>'); $('#form').removeAttr('target'); $('#form').submit(); }" class="button"><?php echo $button_email_client; ?></a>
				<a onclick="if (boxesChecked()) { $('#form').attr('action', '<?php echo $email_owner_pdf; ?>'); $('#form').removeAttr('target'); $('#form').submit(); }" class="button"><?php echo $button_email_owner_pdf; ?></a>
				<a onclick="if (boxesChecked()) { $('#form').attr('action', '<?php echo $email_owner; ?>'); $('#form').removeAttr('target'); $('#form').submit(); }" class="button"><?php echo $button_email_owner; ?></a>
				<a onclick="if (boxesChecked()) { $('#form').attr('action', '<?php echo $invoice_pdf; ?>'); $('#form').attr('target', '_blank'); $('#form').submit(); }" class="button"><?php echo $button_invoice_pdf; ?></a>
				<a onclick="if (boxesChecked()) { $('#form').attr('action', '<?php echo $invoice; ?>'); $('#form').attr('target', '_blank'); $('#form').submit(); }" class="button"><?php echo $button_invoice; ?></a>
			]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
				<tbody>
			]]></search>
			<add><![CDATA[
				<tbody id="checkboxes">
			]]></add>
		</operation>
		<operation>
			<search position="before" index="1"><![CDATA[
				<script type="text/javascript"><!--
			]]></search>
			<add><![CDATA[
				<script type="text/javascript">
					function boxesChecked() {
						if ($('#checkboxes :checkbox:checked').length > 0) {
							return true;
						} else {
							$('.warning').html('<?php echo $error_nothing_checked; ?>');
							$('.warning').show();
							return false;
						}
					}
				</script>
			]]></add>
		</operation>
	</file>
	
	<file name="catalog/controller/account/order.php">
		<operation>
			<search position="before"><![CDATA[
				$this->data['button_view'] = $this->language->get('button_view');
			]]></search>
			<add><![CDATA[
				$this->data['button_print'] = $this->language->get('button_print');
				$this->data['button_email'] = $this->language->get('button_email');
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
				=> $result['order_id'],
			]]></search>
			<add><![CDATA[
				'invoice_href'		=> $this->url->link('account/order/printOrder', 'order_id=' . $result['order_id'] . '&type=print', 'SSL'),
			]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
				public function info() {
			]]></search>
			<add><![CDATA[
				public function printOrder() {
					$order_id = $this->request->get['order_id'];
					$this->load->model('checkout/order');
					$order_info = $this->model_checkout_order->getOrder($order_id);
					$order_product_query = $this->db->query("SELECT * FROM " . DB_PREFIX . "order_product WHERE order_id = '" . (int)$order_id . "'");
					$order_download_query = $this->db->query("SELECT * FROM " . DB_PREFIX . "order_download WHERE order_id = '" . (int)$order_id . "'");
					if (version_compare(VERSION, '1.5.1.3.1', '>')) {
						$order_voucher_query = $this->db->query("SELECT * FROM " . DB_PREFIX . "order_voucher WHERE order_id = '" . (int)$order_id . "'");
					}
					$order_total_query = $this->db->query("SELECT * FROM `" . DB_PREFIX . "order_total` WHERE order_id = '" . (int)$order_id . "' ORDER BY sort_order ASC");
					$language = new Language($order_info['language_directory']);
					$language->load($order_info['language_filename']);
					$language->load('mail/order');
					$order_status_query = $this->db->query("SELECT * FROM " . DB_PREFIX . "order_status WHERE order_status_id = '" . (int)$order_info['order_status_id'] . "' AND language_id = '" . (int)$order_info['language_id'] . "'");
					if ($order_status_query->num_rows) {
						$order_status = $order_status_query->row['name'];	
					} else {
						$order_status = '';
					}
					if (isset($order_info['layaway_deposit']) && $order_info['layaway_deposit'] != 0.0000 && $order_info['layaway_deposit'] != "") {
						$layaways = $this->db->query("SELECT * FROM " . DB_PREFIX . "order_layaway WHERE order_id = '" . (int)$order_id . "' ORDER BY date_added DESC");
					}
					$subject = sprintf($language->get('text_new_subject'), $order_info['store_name'], $order_id);
					$template = new Template();
					$template->data['title'] = sprintf($language->get('text_new_subject'), html_entity_decode($order_info['store_name'], ENT_QUOTES, 'UTF-8'), $order_id);
					$template->data['text_greeting'] = sprintf($language->get('text_new_greeting'), html_entity_decode($order_info['store_name'], ENT_QUOTES, 'UTF-8'));
					$template->data['text_link'] = $language->get('text_new_link');
					$template->data['text_download'] = $language->get('text_new_download');
					$template->data['text_order_detail'] = $language->get('text_new_order_detail');
					$template->data['text_instruction'] = $language->get('text_new_instruction');
					$template->data['text_order_id'] = $language->get('text_new_order_id');
					$template->data['text_date_added'] = $language->get('text_new_date_added');
					$template->data['text_payment_method'] = $language->get('text_new_payment_method');	
					$template->data['text_shipping_method'] = $language->get('text_new_shipping_method');
					$template->data['text_email'] = $language->get('text_new_email');
					$template->data['text_telephone'] = $language->get('text_new_telephone');
					$template->data['text_ip'] = $language->get('text_new_ip');
					$template->data['text_payment_address'] = $language->get('text_new_payment_address');
					$template->data['text_shipping_address'] = $language->get('text_new_shipping_address');
					$template->data['text_product'] = $language->get('text_new_product');
					$template->data['text_model'] = $language->get('text_new_model');
					$template->data['text_quantity'] = $language->get('text_new_quantity');
					$template->data['text_price'] = $language->get('text_new_price');
					$template->data['text_total'] = $language->get('text_new_total');
					$template->data['text_footer'] = $language->get('text_new_footer');
					$template->data['text_powered'] = $language->get('text_new_powered');
					$store_url = $order_info['store_url'];
					if (strpos($store_url, "admin") !== false) {
						$store_url = str_replace("admin/", "", $store_url);
						$store_url = str_replace("admin", "", $store_url);
					}
					$template->data['logo'] = $store_url . 'image/' . $this->config->get('config_logo');		
					$template->data['store_name'] = $order_info['store_name'];
					$template->data['store_url'] = $store_url;
					$template->data['customer_id'] = $order_info['customer_id'];
					$template->data['link'] = $store_url . 'index.php?route=account/order/info&order_id=' . $order_id;
					if ($order_download_query->num_rows) {
						$template->data['download'] = $order_info['store_url'] . 'index.php?route=account/download';
					} else {
						$template->data['download'] = '';
					}
					$template->data['order_id'] = $order_id;
					$template->data['date_added'] = date($language->get('date_format_short'), strtotime($order_info['date_added']));    	
					$template->data['payment_method'] = $order_info['payment_method'];
					$template->data['shipping_method'] = $order_info['shipping_method'];
					$template->data['email'] = $order_info['email'];
					$template->data['telephone'] = $order_info['telephone'];
					$template->data['ip'] = $order_info['ip'];
					$template->data['comment'] = nl2br($order_info['comment']);
					if ($order_info['payment_address_format']) {
						$format = $order_info['payment_address_format'];
					} else {
						$format = '{firstname} {lastname}' . "\n" . '{company}' . "\n" . '{address_1}' . "\n" . '{address_2}' . "\n" . '{city} {postcode}' . "\n" . '{zone}' . "\n" . '{country}';
					}
					$find = array(
						'{firstname}',
						'{lastname}',
						'{company}',
						'{address_1}',
						'{address_2}',
						'{city}',
						'{postcode}',
						'{zone}',
						'{zone_code}',
						'{country}'
					);
					$replace = array(
						'firstname' => $order_info['payment_firstname'],
						'lastname'  => $order_info['payment_lastname'],
						'company'   => $order_info['payment_company'],
						'address_1' => $order_info['payment_address_1'],
						'address_2' => $order_info['payment_address_2'],
						'city'      => $order_info['payment_city'],
						'postcode'  => $order_info['payment_postcode'],
						'zone'      => $order_info['payment_zone'],
						'zone_code' => $order_info['payment_zone_code'],
						'country'   => $order_info['payment_country']  
					);
					$template->data['payment_address'] = str_replace(array("\r\n", "\r", "\n"), '<br />', preg_replace(array("/\s\s+/", "/\r\r+/", "/\n\n+/"), '<br />', trim(str_replace($find, $replace, $format))));						
					if ($order_info['shipping_address_format']) {
						$format = $order_info['shipping_address_format'];
					} else {
						$format = '{firstname} {lastname}' . "\n" . '{company}' . "\n" . '{address_1}' . "\n" . '{address_2}' . "\n" . '{city} {postcode}' . "\n" . '{zone}' . "\n" . '{country}';
					}
					$find = array(
						'{firstname}',
						'{lastname}',
						'{company}',
						'{address_1}',
						'{address_2}',
						'{city}',
						'{postcode}',
						'{zone}',
						'{zone_code}',
						'{country}'
					);
					$replace = array(
						'firstname' => $order_info['shipping_firstname'],
						'lastname'  => $order_info['shipping_lastname'],
						'company'   => $order_info['shipping_company'],
						'address_1' => $order_info['shipping_address_1'],
						'address_2' => $order_info['shipping_address_2'],
						'city'      => $order_info['shipping_city'],
						'postcode'  => $order_info['shipping_postcode'],
						'zone'      => $order_info['shipping_zone'],
						'zone_code' => $order_info['shipping_zone_code'],
						'country'   => $order_info['shipping_country']  
					);
					$template->data['shipping_address'] = str_replace(array("\r\n", "\r", "\n"), '<br />', preg_replace(array("/\s\s+/", "/\r\r+/", "/\n\n+/"), '<br />', trim(str_replace($find, $replace, $format))));
					$template->data['products'] = array();
					foreach ($order_product_query->rows as $product) {
						$option_data = array();
						$order_option_query = $this->db->query("SELECT * FROM " . DB_PREFIX . "order_option WHERE order_id = '" . (int)$order_id . "' AND order_product_id = '" . (int)$product['order_product_id'] . "'");
						foreach ($order_option_query->rows as $option) {
							if ($option['type'] != 'file') {
								$value = $option['value'];
							} else {
								$value = utf8_substr($option['value'], 0, utf8_strrpos($option['value'], '.'));
							}
							$option_data[] = array(
								'name'  => $option['name'],
								'value' => (utf8_strlen($value) > 20 ? utf8_substr($value, 0, 20) . '..' : $value)
							);					
						}
						if (version_compare(VERSION, '1.5.1.3.1', '>')) {
							$price = $this->currency->format($product['price'] + ($this->config->get('config_tax') ? $product['tax'] : 0), $order_info['currency_code'], $order_info['currency_value']);
							$total = $this->currency->format($product['total'] + ($this->config->get('config_tax') ? ($product['tax'] * $product['quantity']) : 0), $order_info['currency_code'], $order_info['currency_value']);
						} else {
							$price = $this->currency->format($product['price'], $order_info['currency_code'], $order_info['currency_value']);
							$total = $this->currency->format($product['total'], $order_info['currency_code'], $order_info['currency_value']);
						}
						$template->data['products'][] = array(
							'name'     => $product['name'],
							'model'    => $product['model'],
							'option'   => $option_data,
							'quantity' => $product['quantity'],
							'price'    => $price,
							'total'    => $total
						);
					}
					$template->data['vouchers'] = array();
					if (version_compare(VERSION, '1.5.1.3.1', '>')) {
						foreach ($order_voucher_query->rows as $voucher) {
							$template->data['vouchers'][] = array(
								'description' => $voucher['description'],
								'amount'      => $this->currency->format($voucher['amount'], $order_info['currency_code'], $order_info['currency_value']),
							);
						}
					}
					$template->data['totals'] = $order_total_query->rows;
					if (isset($layaways)) {
						$template->data['deposit_layaway'] = $this->currency->format($order_info['layaway_deposit']);
						$template->data['layaways'] = array();
						$total_paid = 0;
						foreach ($layaways->rows as $layaway) {
							$total_paid = $layaway['deposit'];
							if (!empty($layaway['payments'])) {
								foreach (unserialize($layaway['payments']) as $payment) {
									$total_paid += $payment['payment_amount'];
									$template->data['layaways'][] = array(
										'amount'		=> $this->currency->format($payment['payment_amount'], $this->config->get('config_currency')),
										'description'	=> $payment['payment_description'],
										'date_added'	=> date($this->language->get('date_format_short'), ($payment['payment_date']))
									);
								}
							}
						}
						$template->data['layaway_balance'] = $this->currency->format($order_info['total'] - $total_paid);
					}
					if (file_exists(DIR_TEMPLATE . $this->config->get('config_template') . '/template/mail/order.tpl')) {
						$html = $template->fetch($this->config->get('config_template') . '/template/mail/order.tpl');
					} else {
						$html = $template->fetch('default/template/mail/order.tpl');
					}
					require_once(DIR_SYSTEM . 'library/dompdf/dompdf_config.inc.php');
					$dompdf = new DOMPDF();
					$dompdf->load_html($html);
					$dompdf->render();
					$pdfoutput = $dompdf->output();
					$filepath = DIR_CACHE;
					$filename = "invoice_" . $order_id . ".pdf";
					$fp = fopen($filepath . $filename, "w");
					fwrite($fp, $pdfoutput);
					fclose($fp);
					if ($this->request->get['type'] == "email") {
						$mail = new Mail(); 
						$mail->protocol = $this->config->get('config_mail_protocol');
						$mail->parameter = $this->config->get('config_mail_parameter');
						$mail->hostname = $this->config->get('config_smtp_host');
						$mail->username = $this->config->get('config_smtp_username');
						$mail->password = $this->config->get('config_smtp_password');
						$mail->port = $this->config->get('config_smtp_port');
						$mail->timeout = $this->config->get('config_smtp_timeout');			
						$mail->setTo($order_info['email']);
						$mail->setFrom($this->config->get('config_email'));
						$mail->setSender($order_info['store_name']);
						$mail->setSubject(html_entity_decode($subject, ENT_QUOTES, 'UTF-8'));
						$mail->setHtml($html);
						$mail->addAttachment($filepath . $filename, $filename);
						$mail->send();
						unlink($filepath . $filename);
						echo json_encode("An email containing your order information has been sent!");
					} else {
						header('Content-Transfer-Encoding: binary');
						header('Content-Type: application/pdf');
						header('Content-Disposition: attachment; filename="' . $filename . '"');
						header('Content-Length: '.filesize($filepath . $filename));
						readfile($filepath . $filename);
						unlink($filepath . $filename);
						$this->response->setOutput($html);
					}
				}
			]]></add>
		</operation>
	</file>
	
	<file name="catalog/language/english/account/order.php">
		<operation>
			<search position="after"><![CDATA[
				$_['column_comment']        = 'Comment';
			]]></search>
			<add><![CDATA[
				// Button
				$_['button_print']		= 'Print';
				$_['button_email']		= 'Email';
			]]></add>
		</operation>
	</file>
	
	<file name="catalog/model/checkout/order.php">
		<operation>
			<search position="before"><![CDATA[
				$language_info = $this->model_localisation_language->getLanguage($order_query->row['language_id']);
			]]></search>
			<add><![CDATA[
				if (isset($order_query->row['layaway_deposit'])) {
					$layaway_deposit = $order_query->row['layaway_deposit'];
				} else {
					$layaway_deposit = "";
				}
			]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
				'date_modified'           => $order_query->row['date_modified'],
			]]></search>
			<add><![CDATA[
				'layaway_deposit'         => $layaway_deposit,
			]]></add>
		</operation>
	</file>
	
	<file name="catalog/view/theme/default/template/account/order_list.tpl">
		<operation>
			<search position="after"><![CDATA[
				<?php if ($orders) { ?>
			]]></search>
			<add><![CDATA[
				<form action="" method="post" enctype="multipart/form-data" id="form"></form>
			]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
				<div class="order-info">
			]]></search>
			<add><![CDATA[
				<div class="order-info">
					<a onclick="emailOrder(<?php echo $order['order_id']; ?>);"><img src="catalog/view/theme/default/image/email.gif" alt="<?php echo $button_email; ?>" title="<?php echo $button_email; ?>" /></a>&nbsp;&nbsp;
					<a onclick="$('#form').attr('action', '<?php echo $order['invoice_href']; ?>'); $('#form').attr('target', '_blank'); $('#form').submit();"><img src="catalog/view/theme/default/image/print.png" alt="<?php echo $button_print; ?>" title="<?php echo $button_print; ?>" /></a>&nbsp;&nbsp;
			]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
				<?php echo $footer; ?>
			]]></search>
			<add><![CDATA[
				<script type="text/javascript">
					function emailOrder(order_id) {
						$.ajax({
							url: 'index.php?route=account/order/printOrder&order_id=' + order_id + '&type=email',
							type: 'GET',
							dataType: 'json',
							success: function(json) {
								alert(json);
							}
						});
					}
					function printOrder(order_id) {
						var new_window = window.open();
						$.ajax({
							url: 'index.php?route=account/order/printOrder&order_id=' + order_id + '&type=print',
							type: 'GET',
							dataType: 'json',
							success: function(json) {
								new_window.document.write(json);
								new_window.print();
								new_window.close();
							}
						});
					}
				</script>
			]]></add>
		</operation>
	</file>
	
	<file name="catalog/view/theme/default/template/mail/order.tpl">
		<operation>
			<search position="before"><![CDATA[
				</tfoot>
			]]></search>
			<add><![CDATA[
				<?php if (version_compare(VERSION, '1.5.1.3.1', '>')) { ?>
					<?php if (isset($layaways)) { ?>
						<tr>
							<td style="font-size: 12px;	border-right: 1px solid #DDDDDD; border-bottom: 1px solid #DDDDDD; text-align: right; padding: 7px;" colspan="4"><b>Layaway Deposit:</b></td>
							<td style="font-size: 12px;	border-right: 1px solid #DDDDDD; border-bottom: 1px solid #DDDDDD; text-align: right; padding: 7px;"><?php echo $deposit_layaway; ?></td>
						</tr>
						<?php foreach ($layaways as $layaway) { ?>
							<tr>
								<td style="font-size: 12px;	border-right: 1px solid #DDDDDD; border-bottom: 1px solid #DDDDDD; text-align: right; padding: 7px;" colspan="4"><b><?php echo $layaway['date_added']; ?> - <?php echo $layaway['description']; ?>:</b></td>
								<td style="font-size: 12px;	border-right: 1px solid #DDDDDD; border-bottom: 1px solid #DDDDDD; text-align: right; padding: 7px;"><?php echo $layaway['amount']; ?></td>
							</tr>						
						<?php } ?>
						<tr>
							<td style="font-size: 12px;	border-right: 1px solid #DDDDDD; border-bottom: 1px solid #DDDDDD; text-align: right; padding: 7px;" colspan="4"><b>Layaway Balance:</b></td>
							<td style="font-size: 12px;	border-right: 1px solid #DDDDDD; border-bottom: 1px solid #DDDDDD; text-align: right; padding: 7px;"><?php echo $layaway_balance; ?></td>
						</tr>
					<?php } ?>
				<?php } else { ?>
					<?php if (isset($layaways)) { ?>
						<tr>
							<td colspan="4" class="right"><b>Layaway Deposit:</b></td>
							<td class="right"><?php echo $deposit_layaway; ?></td>
						</tr>
						<?php foreach ($layaways as $layaway) { ?>
							<tr>
								<td colspan="4" class="right"><b><?php echo $layaway['date_added']; ?> - <?php echo $layaway['description']; ?>:</b></td>
								<td class="right"><?php echo $layaway['amount']; ?></td>
							</tr>						
						<?php } ?>
						<tr>
							<td colspan="4" class="right"><b>Layaway Balance:</b></td>
							<td class="right"><?php echo $layaway_balance; ?></td>
						</tr>
					<?php } ?>
				<?php } ?>
			]]></add>
		</operation>
	</file>
	
</modification>